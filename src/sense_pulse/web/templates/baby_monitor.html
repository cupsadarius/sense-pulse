{% extends "base.html" %}

{% block title %}Baby Monitor - Sense Pulse{% endblock %}

{% block head %}
<!-- HLS.js for HLS playback -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
<style>
    /* Dark theme optimized for night viewing */
    .video-container {
        background: #000;
        border-radius: 0.75rem;
        overflow: hidden;
    }

    video {
        width: 100%;
        height: auto;
        display: block;
        background: #000;
    }

    /* Fullscreen styles */
    .video-container:fullscreen {
        border-radius: 0;
    }

    .video-container:fullscreen video {
        height: 100vh;
        object-fit: contain;
    }

    /* Status indicator animations */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .status-streaming {
        animation: pulse 2s ease-in-out infinite;
    }

    /* Control button styles */
    .control-btn {
        transition: all 0.2s ease;
    }

    .control-btn:hover {
        transform: scale(1.1);
    }

    .control-btn:active {
        transform: scale(0.95);
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<header class="border-b border-sense-border bg-sense-card/50 backdrop-blur-sm sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="/" class="text-gray-400 hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
            </a>
            <div class="w-10 h-10 bg-gradient-to-br from-pink-400 to-purple-500 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold">Baby Monitor</h1>
                <p class="text-xs text-gray-400">Live Stream Viewer</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <!-- Stream Status -->
            <div class="flex items-center gap-2 px-3 py-1 bg-gray-800 rounded-full" id="status-badge">
                <span class="w-2 h-2 rounded-full bg-gray-500" id="status-indicator"></span>
                <span class="text-xs text-gray-400" id="status-text">Connecting...</span>
            </div>
        </div>
    </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6">
    {% if not enabled %}
    <!-- Disabled State -->
    <div class="bg-sense-card rounded-xl border border-sense-border p-8 text-center">
        <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
        </div>
        <h2 class="text-xl font-semibold text-gray-300 mb-2">Baby Monitor Not Configured</h2>
        <p class="text-gray-500 mb-6">Add your camera's RTSP URL in the configuration file to enable the baby monitor.</p>
        <div class="bg-gray-800 rounded-lg p-4 text-left max-w-md mx-auto">
            <p class="text-sm text-gray-400 mb-2">Add to config.yaml:</p>
            <pre class="text-xs text-cyan-400 overflow-x-auto">baby_monitor:
  enabled: true
  rtsp_url: "rtsp://user:pass@camera-ip:554/stream"</pre>
        </div>
    </div>
    {% else %}
    <!-- Video Player -->
    <div class="video-container mb-6 relative group" id="video-container">
        <video id="video-player" playsinline autoplay muted>
            Your browser does not support the video tag.
        </video>

        <!-- Loading Overlay -->
        <div class="absolute inset-0 flex items-center justify-center bg-black/80" id="loading-overlay">
            <div class="text-center">
                <div class="w-12 h-12 border-4 border-gray-600 border-t-cyan-500 rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-gray-400" id="loading-text">Connecting to stream...</p>
            </div>
        </div>

        <!-- Error Overlay -->
        <div class="absolute inset-0 flex items-center justify-center bg-black/90 hidden" id="error-overlay">
            <div class="text-center p-6">
                <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <p class="text-red-400 font-semibold mb-2">Stream Error</p>
                <p class="text-gray-500 text-sm mb-4" id="error-message">Unable to connect to camera</p>
                <button onclick="retryConnection()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg transition-colors">
                    Retry
                </button>
            </div>
        </div>

        <!-- Controls Overlay (visible on hover/tap) -->
        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" id="controls-overlay">
            <div class="flex items-center justify-between">
                <!-- Left controls -->
                <div class="flex items-center gap-4">
                    <!-- Mute/Unmute -->
                    <button onclick="toggleMute()" class="control-btn p-2 bg-gray-800/80 rounded-full hover:bg-gray-700" id="mute-btn" title="Toggle audio">
                        <svg class="w-6 h-6 text-white" id="mute-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" id="mute-x"/>
                        </svg>
                    </button>
                </div>

                <!-- Right controls -->
                <div class="flex items-center gap-4">
                    <!-- Restart Stream -->
                    <button onclick="restartStream()" class="control-btn p-2 bg-gray-800/80 rounded-full hover:bg-gray-700" title="Restart stream">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>

                    <!-- Fullscreen -->
                    <button onclick="toggleFullscreen()" class="control-btn p-2 bg-gray-800/80 rounded-full hover:bg-gray-700" title="Toggle fullscreen">
                        <svg class="w-6 h-6 text-white" id="fullscreen-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stream Info -->
    <div class="bg-sense-card rounded-xl border border-sense-border p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Stream Information</h2>
            <button onclick="restartStream()" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white text-sm rounded-lg transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Restart Stream
            </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-800/50 rounded-lg p-4">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Status</p>
                <p class="text-lg font-semibold capitalize" id="info-status">-</p>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Uptime</p>
                <p class="text-lg font-semibold" id="info-uptime">-</p>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Resolution</p>
                <p class="text-lg font-semibold" id="info-resolution">-</p>
            </div>
            <div class="bg-gray-800/50 rounded-lg p-4">
                <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">FPS</p>
                <p class="text-lg font-semibold" id="info-fps">-</p>
            </div>
        </div>

        <!-- Error message if any -->
        <div class="mt-4 p-4 bg-red-900/20 border border-red-700 rounded-lg hidden" id="info-error-box">
            <p class="text-sm text-red-400" id="info-error"></p>
        </div>
    </div>
    {% endif %}
</main>

{% if enabled %}
<script>
    // State
    let hls = null;
    let video = null;
    let statusWs = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;

    // DOM elements
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorOverlay = document.getElementById('error-overlay');
    const errorMessage = document.getElementById('error-message');
    const loadingText = document.getElementById('loading-text');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const muteIcon = document.getElementById('mute-icon');
    const muteX = document.getElementById('mute-x');

    // Initialize video player
    function initPlayer() {
        video = document.getElementById('video-player');

        // Check for native HLS support (Safari)
        if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = '/baby-monitor/stream/stream.m3u8';
            setupVideoEvents();
        }
        // Use HLS.js for other browsers
        else if (Hls.isSupported()) {
            hls = new Hls({
                liveSyncDurationCount: 1,  // Lower latency
                liveMaxLatencyDurationCount: 3,
                maxBufferLength: 10,
                maxMaxBufferLength: 30,
                enableWorker: true,
            });

            hls.loadSource('/baby-monitor/stream/stream.m3u8');
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                hideLoading();
                video.play().catch(console.error);
            });

            hls.on(Hls.Events.ERROR, function(event, data) {
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            showError('Network error - check camera connection');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            hls.recoverMediaError();
                            break;
                        default:
                            showError('Stream error - trying to recover');
                            hls.destroy();
                            setTimeout(initPlayer, 3000);
                            break;
                    }
                }
            });

            setupVideoEvents();
        }
        else {
            showError('HLS playback not supported in this browser');
        }
    }

    function setupVideoEvents() {
        video.addEventListener('playing', function() {
            hideLoading();
            hideError();
            reconnectAttempts = 0;
        });

        video.addEventListener('waiting', function() {
            loadingText.textContent = 'Buffering...';
            showLoading();
        });

        video.addEventListener('error', function(e) {
            console.error('Video error:', e);
            showError('Video playback error');
        });

        video.addEventListener('stalled', function() {
            loadingText.textContent = 'Stream stalled...';
        });
    }

    function showLoading() {
        loadingOverlay.classList.remove('hidden');
        errorOverlay.classList.add('hidden');
    }

    function hideLoading() {
        loadingOverlay.classList.add('hidden');
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorOverlay.classList.remove('hidden');
        loadingOverlay.classList.add('hidden');

        // Auto-retry with exponential backoff
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
            setTimeout(retryConnection, delay);
        }
    }

    function hideError() {
        errorOverlay.classList.add('hidden');
    }

    function retryConnection() {
        hideError();
        loadingText.textContent = 'Reconnecting...';
        showLoading();

        if (hls) {
            hls.destroy();
        }
        initPlayer();
    }

    // Control functions
    function toggleMute() {
        if (video) {
            video.muted = !video.muted;
            updateMuteIcon();
        }
    }

    function updateMuteIcon() {
        if (video && video.muted) {
            muteX.style.display = 'block';
        } else {
            muteX.style.display = 'none';
        }
    }

    function toggleFullscreen() {
        const container = document.getElementById('video-container');

        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            container.requestFullscreen().catch(console.error);
        }
    }

    async function restartStream() {
        try {
            loadingText.textContent = 'Restarting stream...';
            showLoading();

            const response = await fetch('/baby-monitor/api/restart', {
                method: 'POST',
            });

            const result = await response.json();

            if (result.success) {
                // Wait for stream to restart
                setTimeout(retryConnection, 3000);
            } else {
                showError(result.message || 'Failed to restart stream');
            }
        } catch (error) {
            showError('Failed to restart stream');
            console.error('Restart error:', error);
        }
    }

    // Status WebSocket
    function connectStatusWs() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/baby-monitor/ws/status';

        statusWs = new WebSocket(wsUrl);

        statusWs.onmessage = function(event) {
            const status = JSON.parse(event.data);
            updateStatusDisplay(status);
        };

        statusWs.onclose = function() {
            // Reconnect after 3 seconds
            setTimeout(connectStatusWs, 3000);
        };

        statusWs.onerror = function(error) {
            console.error('Status WebSocket error:', error);
        };
    }

    function updateStatusDisplay(status) {
        // Update status badge
        const indicator = document.getElementById('status-indicator');
        const text = document.getElementById('status-text');

        switch (status.status) {
            case 'streaming':
                indicator.className = 'w-2 h-2 rounded-full bg-green-500 status-streaming';
                text.textContent = 'Live';
                text.className = 'text-xs text-green-400';
                break;
            case 'reconnecting':
                indicator.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                text.textContent = 'Reconnecting';
                text.className = 'text-xs text-yellow-400';
                break;
            case 'starting':
                indicator.className = 'w-2 h-2 rounded-full bg-cyan-500 animate-pulse';
                text.textContent = 'Starting';
                text.className = 'text-xs text-cyan-400';
                break;
            case 'error':
                indicator.className = 'w-2 h-2 rounded-full bg-red-500';
                text.textContent = 'Error';
                text.className = 'text-xs text-red-400';
                break;
            default:
                indicator.className = 'w-2 h-2 rounded-full bg-gray-500';
                text.textContent = status.status || 'Unknown';
                text.className = 'text-xs text-gray-400';
        }

        // Update info panel
        document.getElementById('info-status').textContent = status.status || '-';
        document.getElementById('info-status').className = status.status === 'streaming' ?
            'text-lg font-semibold text-green-400 capitalize' : 'text-lg font-semibold capitalize';

        // Format uptime
        const uptime = status.uptime_seconds || 0;
        if (uptime > 0) {
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = Math.floor(uptime % 60);
            document.getElementById('info-uptime').textContent =
                hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m ${seconds}s`;
        } else {
            document.getElementById('info-uptime').textContent = '-';
        }

        // Resolution and FPS
        document.getElementById('info-resolution').textContent = status.camera?.resolution || '-';
        document.getElementById('info-fps').textContent = status.camera?.fps ? `${status.camera.fps}` : '-';

        // Error display
        const errorBox = document.getElementById('info-error-box');
        const errorText = document.getElementById('info-error');
        if (status.error) {
            errorBox.classList.remove('hidden');
            errorText.textContent = status.error;
        } else {
            errorBox.classList.add('hidden');
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initPlayer();
        connectStatusWs();
        updateMuteIcon();

        // Handle visibility change - pause/resume when tab is hidden/visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (video) video.pause();
            } else {
                if (video) video.play().catch(console.error);
            }
        });
    });
</script>
{% endif %}
{% endblock %}
